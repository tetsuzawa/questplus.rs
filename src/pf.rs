use ndarray::prelude::*;
use statrs::distribution::{Normal, Univariate};
use std::error::Error;

pub fn norm_cdf(
    intensity: &Array1<f64>,
    mean: &Array1<f64>,
    sd: &Array1<f64>,
    lower_asymptote: &Array1<f64>,
    lapse_rate: &Array1<f64>,
) -> Result<Array5<f64>, Box<dyn Error>> {
    let f = |x, mean, sd, lower_asymptote, lapse_rate| -> Result<f64, Box<dyn Error>> {
        let norm = Normal::new(mean, sd)?;
        Ok(lower_asymptote + (1.0 - lower_asymptote - lapse_rate) * norm.cdf(x))
    };
    let num_elements =
        intensity.len() * mean.len() * sd.len() * lower_asymptote.len() * lapse_rate.len();
    let mut v = Vec::with_capacity(num_elements);
    for x in intensity.iter() {
        for m in mean.iter() {
            for s in sd.iter() {
                for la in lower_asymptote.iter() {
                    for lr in lapse_rate.iter() {
                        v.push(f(*x, *m, *s, *la, *lr)?);
                    }
                }
            }
        }
    }
    Ok(Array::from_shape_vec(
        (
            intensity.len(),
            mean.len(),
            sd.len(),
            lower_asymptote.len(),
            lapse_rate.len(),
        ),
        v,
    )?
    .into())
}

#[cfg(test)]
mod tests {
    use crate::pf::norm_cdf;
    use ndarray::prelude::*;

    #[test]
    fn test_norm_cdf() {
        let intensity: Array1<f64> = Array1::range(0., 50., 1.);
        let mean: Array1<f64> = Array1::range(7., 9., 1.);
        let sd: Array1<f64> = Array1::range(7., 8., 0.5);
        let lower_asymptote: Array1<f64> = arr1(&[0.5]);
        let lapse_rate: Array1<f64> = Array1::range(0.01, 0.02, 0.01);

        let num_elements =
            intensity.len() * mean.len() * sd.len() * lower_asymptote.len() * lapse_rate.len();

        let result = norm_cdf(&intensity, &mean, &sd, &lower_asymptote, &lapse_rate).unwrap();
        println!("{:?}", result);
        // want_slice is generated by Python code
        let want_slice = [
            [
                [[[0.577741074426414]], [[0.5859087329775925]]],
                [[[0.5620089876920433]], [[0.5700999841757994]]],
            ],
            [
                [[[0.5958846548853503]], [[0.6038091453058644]]],
                [[[0.577741074426414]], [[0.5859087329775925]]],
            ],
            [
                [[[0.6163873783932184]], [[0.6237213433979922]]],
                [[[0.5958846548853503]], [[0.6038091453058644]]],
            ],
            [
                [[[0.6390887457183514]], [[0.6454817000158871]]],
                [[[0.6163873783932184]], [[0.6237213433979922]]],
            ],
            [
                [[[0.6637176097398361]], [[0.6688433466109411]]],
                [[[0.6390887457183514]], [[0.6454817000158871]]],
            ],
            [
                [[[0.6898987557380163]], [[0.6934828261273723]]],
                [[[0.6637176097398361]], [[0.6688433466109411]]],
            ],
            [
                [[[0.7171687365599306]], [[0.7190127928544292]]],
                [[[0.6898987557380163]], [[0.6934828261273723]]],
            ],
            [
                [[[0.745]], [[0.745]]],
                [[[0.7171687365599306]], [[0.7190127928544292]]],
            ],
            [
                [[[0.7728312634400694]], [[0.7709872071455709]]],
                [[[0.745]], [[0.745]]],
            ],
            [
                [[[0.8001012442619837]], [[0.7965171738726278]]],
                [[[0.7728312634400694]], [[0.7709872071455709]]],
            ],
            [
                [[[0.8262823902601639]], [[0.8211566533890589]]],
                [[[0.8001012442619837]], [[0.7965171738726278]]],
            ],
            [
                [[[0.8509112542816486]], [[0.844518299984113]]],
                [[[0.8262823902601639]], [[0.8211566533890589]]],
            ],
            [
                [[[0.8736126216067814]], [[0.8662786566020078]]],
                [[[0.8509112542816486]], [[0.844518299984113]]],
            ],
            [
                [[[0.8941153451146497]], [[0.8861908546941357]]],
                [[[0.8736126216067814]], [[0.8662786566020078]]],
            ],
            [
                [[[0.912258925573586]], [[0.9040912670224075]]],
                [[[0.8941153451146497]], [[0.8861908546941357]]],
            ],
            [
                [[[0.9279910123079567]], [[0.9199000158242006]]],
                [[[0.912258925573586]], [[0.9040912670224075]]],
            ],
            [
                [[[0.9413570155467679]], [[0.933615861591363]]],
                [[[0.9279910123079567]], [[0.9199000158242006]]],
            ],
            [
                [[[0.952483774500181]], [[0.9453065023343248]]],
                [[[0.9413570155467679]], [[0.933615861591363]]],
            ],
            [
                [[[0.9615596322340295]], [[0.9550956450671468]]],
                [[[0.952483774500181]], [[0.9453065023343248]]],
            ],
            [
                [[[0.9688133149540519]], [[0.9631483470672166]]],
                [[[0.9615596322340295]], [[0.9550956450671468]]],
            ],
            [
                [[[0.9744937461028305]], [[0.9696560723524983]]],
                [[[0.9688133149540519]], [[0.9631483470672166]]],
            ],
            [
                [[[0.9788524353453922]], [[0.9748227029036971]]],
                [[[0.9744937461028305]], [[0.9696560723524983]]],
            ],
            [
                [[[0.9821294800541241]], [[0.9788524353453922]]],
                [[[0.9788524353453922]], [[0.9748227029036971]]],
            ],
            [
                [[[0.984543610154988]], [[0.9819401390468547]]],
                [[[0.9821294800541241]], [[0.9788524353453922]]],
            ],
            [
                [[[0.9862861824750273]], [[0.9842644039405264]]],
                [[[0.984543610154988]], [[0.9819401390468547]]],
            ],
            [
                [[[0.9875186423153992]], [[0.9859832073969479]]],
                [[[0.9862861824750273]], [[0.9842644039405264]]],
            ],
            [
                [[[0.9883727380582754]], [[0.9872319053497753]]],
                [[[0.9875186423153992]], [[0.9859832073969479]]],
            ],
            [
                [[[0.9889526901797577]], [[0.988123113521881]]],
                [[[0.9883727380582754]], [[0.9872319053497753]]],
            ],
            [
                [[[0.9893385499645013]], [[0.9887479861380903]]],
                [[[0.9889526901797577]], [[0.988123113521881]]],
            ],
            [
                [[[0.9895900966930726]], [[0.9891784080685382]]],
                [[[0.9893385499645013]], [[0.9887479861380903]]],
            ],
            [
                [[[0.9897507758691695]], [[0.9894696727641172]]],
                [[[0.9895900966930726]], [[0.9891784080685382]]],
            ],
            [
                [[[0.9898513421228192]], [[0.9896633024104212]]],
                [[[0.9897507758691695]], [[0.9894696727641172]]],
            ],
            [
                [[[0.989913015351717]], [[0.9897897604367336]]],
                [[[0.9898513421228192]], [[0.9896633024104212]]],
            ],
            [
                [[[0.9899500742774074]], [[0.9898708960418583]]],
                [[[0.989913015351717]], [[0.9897897604367336]]],
            ],
            [
                [[[0.9899718935703437]], [[0.9899220367908228]]],
                [[[0.9899500742774074]], [[0.9898708960418583]]],
            ],
            [
                [[[0.9899844810915017]], [[0.9899537042488459]]],
                [[[0.9899718935703437]], [[0.9899220367908228]]],
            ],
            [
                [[[0.9899915963622526]], [[0.9899729683978367]]],
                [[[0.9899844810915017]], [[0.9899537042488459]]],
            ],
            [
                [[[0.9899955372521985]], [[0.9899844810915017]]],
                [[[0.9899915963622526]], [[0.9899729683978367]]],
            ],
            [
                [[[0.9899976759470539]], [[0.9899912402799464]]],
                [[[0.9899955372521985]], [[0.9899844810915017]]],
            ],
            [
                [[[0.989998813194489]], [[0.9899951388256961]]],
                [[[0.9899976759470539]], [[0.9899912402799464]]],
            ],
            [
                [[[0.98999940572772]], [[0.9899973478534851]]],
                [[[0.989998813194489]], [[0.9899951388256961]]],
            ],
            [
                [[[0.9899997082253964]], [[0.9899985775280102]]],
                [[[0.98999940572772]], [[0.9899973478534851]]],
            ],
            [
                [[[0.9899998595407298]], [[0.9899992499928991]]],
                [[[0.9899997082253964]], [[0.9899985775280102]]],
            ],
            [
                [[[0.9899999337051114]], [[0.9899996112692055]]],
                [[[0.9899998595407298]], [[0.9899992499928991]]],
            ],
            [
                [[[0.9899999693222761]], [[0.9899998019468436]]],
                [[[0.9899999337051114]], [[0.9899996112692055]]],
            ],
            [
                [[[0.9899999860823069]], [[0.9899999008136375]]],
                [[[0.9899999693222761]], [[0.9899998019468436]]],
            ],
            [
                [[[0.9899999938098557]], [[0.989999951174311]]],
                [[[0.9899999860823069]], [[0.9899999008136375]]],
            ],
            [
                [[[0.9899999973009386]], [[0.9899999763756135]]],
                [[[0.9899999938098557]], [[0.989999951174311]]],
            ],
            [
                [[[0.9899999988462997]], [[0.9899999887648576]]],
                [[[0.9899999973009386]], [[0.9899999763756135]]],
            ],
            [
                [[[0.989999999516572]], [[0.9899999947483807]]],
                [[[0.9899999988462997]], [[0.9899999887648576]]],
            ],
        ];
        let mut want_vec = Vec::with_capacity(num_elements);
        for a in want_slice.iter() {
            for b in a.iter() {
                for c in b.iter() {
                    for d in c.iter() {
                        for e in d.iter() {
                            want_vec.push(*e);
                        }
                    }
                }
            }
        }
        let want: Array5<f64> = Array::from_shape_vec(
            (
                intensity.len(),
                mean.len(),
                sd.len(),
                lower_asymptote.len(),
                lapse_rate.len(),
            ),
            want_vec,
        )
        .unwrap()
        .into();
        assert!(result.all_close(&want, 1e-8));
    }
}
